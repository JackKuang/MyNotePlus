# 大数据层次

## 一、概述

数据分层是数据仓库设计中十分重要的一个环节，优秀的分层实际能够让整个数据体系更易理解和使用。

作为数据的规划以及开发者，我们肯定希望自己数据有秩序地流转，数据的整个生命周期能够清晰明确被设计者和使用者感知到。直观来讲就是如下左图这般层次清晰、依赖关系直观。

但是，大多数情况下，我们完成的数据体系缺失依赖复杂、层级混乱的。如下的右图，在不知不觉的情况下，我门可能会做出一套表依赖结构混乱，甚至出现循环依赖的数据体系。

![img](http://img.hurenjieee.com/uPic/906988-20190325114455533-937308352.png)

因此，我们需要一套有效的数据组织和管理方法来让我门的数据体系更有序，这也就是数据分层。数据分层并不能解决所有的数据问题，但是却可以给我们带来以下好处：

* **清晰的数据结构**

  > 每一个数据分层都有它的作用域和职责，在使用表的时候能更方便地定位和理解。

* **减少重复开发**

  > 规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算。

* **统一数据口径**

  > 通过数据分层，提供统一的数据出口，统一对外数据的数据口径。

* **复杂问题简单化**

  > 将一个复杂度的任务分解成多个步骤来完成，每一层解决特定的问题。

## 二、通用数据分层设计

为了满足前面提到的数据分层带来的好处，我们将数据分为三层：

* **数据运营层（ODS）**

  > 存放的是接入的原始数据。

* **数据仓库层（DW）**

  > 重点设计的数据仓库中间层数据

* **数据应用层（APP）**

  > 面向业务定制的应用数据

![img](http://img.hurenjieee.com/uPic/906988-20190325114414059-144591177.png)

### 2.1 数据运营层：ODS（Operational Data Store）

“面向主题”的数据运营层，也叫ODS层，是最接近数据源中数据的一层，数据源中的数据，经过ETL（抽取、清晰、传输）装入本层。本层的数据大多是按照源头业务系统的分类方式而分类的。

一般来讲，为了考虑后续需要追溯数据问题，因此对于这一层就不建议做过多的数据清晰工作，原封不动地介入原始数据即可，至于数据的清洗、去重、异常值处理等过程可以放在后面的DWD层来做。



### 2.2 数据仓库层：DW（Data Warehouse）

数据仓库是我们在做数据仓库时要核心设计的一层，在这里，从ODS层中获取的数据按照主题建立各种数据模型。DW层又细分为以下几层：

* DWD（Data Warehouse Detail）层
* DWM（Data Warehouse Middle）层
* DWS（Data Warehouse Service）层

#### 2.2.1 数据明细层：DWD（Data Warehouse Detail）

该层一般保持和ODS层一样的数据粒度，并提供一定的数据质量保证。同时，为了提高数据明细层的易用性，该层灰采取一些维度退化手法，将维度退化至事实表中，减少事实表和维表的关联。。

另外，在该层也会做一部分的数据聚合，将相同 主题的数据汇集到一张表中，提高数据的可用性。

#### 2.2.2 数据中间层：DWM（Data Warehouse Middle）

该层会在DWD层的数据基础上，对数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。

直观来讲，就是对通用的核心维度进行聚合草足，算出相应的统计指标。

#### 2.2.3 数据服务层：DWS（Data Warehouse Service）

又称数据集市或者宽表。按照业务划分，如流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等。

一般来说，该层的数据表会相对比较少，一张表会涵盖比较多的业务内容，由于其字段比较多，因此一般也会称该层的表为宽表。



在实际计算中，如果直接从DWD或者ODS计算出宽表的统计指标，会存在计算量太大并且为度太少的问题，因此一般的做法是，在DWM层先计算出多个小的中间表，然后在拼接成一个DWS的宽表。由于宽和窄的界限不易界定，也可以去掉DWM层，只保留DWS，将所有的数据放在DWS亦可。



### 2.3 数据应用层：APP（Application）

在这里，主要是提供给数据产品和数据分析使用的数据，一般会存放在ES、PostgreSQL、Redis等系统中供献上系统使用，也可能存在Hive或者Druid中提供数据分析和数据挖掘使用。比如报表数据。



### 2.4 维表层（Dimension）

补充一个维表层，主要包含两部分数据：

* 高基数维度数据

  > 一般是用户资料表、商品资料表类似的资料表哦。
  >
  > 数据量可能是千万级或者上亿级别。

* 低基数维度数据

  > 一般是配置表，比比如枚举中对应的中文含义，或者日期维表。
  >
  > 数据量可能是个位数、千或者万级别。

![img](http://img.hurenjieee.com/uPic/906988-20190325114328303-818127837.png)

## 三、Example

我们可以举一个电商网站的数据体系设计。涉及业务为用户访问日志：

在ODS层，由于各端的开发团队不同或者其他一些原因，用户的访问日志被分为若干张表上报我们的ODS层。

在DWD层，为了方便大家使用，我门在DWD层做了一张用户访问记录表，在这里，我们将PC网页、H5、小程序和原生APP访问日志汇聚到一张表里面，统一字段名，提升数据质量，这就就有了一张可以提供大家访问的明细表了。

在DWM层，我们会从DWD层中选取业务关注的核心维度来做聚合操作，比如只保留人、商品、设别和页面区域维度。类似地，我们这样做了很多个DWM中间表。

在DWS层，我门将一个人在整个网站中的行为数据放到一张表中，这就是我们的宽表，有了这张表，就可以快速满足大部分的通用型业务需求。

在APP层，根据需要从DWS层的一张或者多张表中取出数据拼接成一张应用表即可。

![img](http://img.hurenjieee.com/uPic/906988-20190325114301696-518774573.png)

## 四、技术实践

我们聊了聊将分层之后，聊一聊计算与存储引擎，一般如下：

* **Data Source**

  > 数据源一般是业务库和埋点。
  >
  > 存储选择一般是Mysql、PostgreSQL或是文件系统。

* **ODS**

  > ODS的数据量会非常大大。
  >
  > 存储选择会选择HDFS，即Hive或HBase。

* **DW**

  > 一般与ODS一致，但是为了满足更多的需求，也会有存放在PG和ES中。

* **APP**

  > 应用层的数据，一般都要求比较快的响应速度。
  >
  > 存储选择一般是Mysql、PG、Redis等。

![img](http://img.hurenjieee.com/uPic/906988-20190325114224824-1200969304.png)

## 五、分层的思考

### 5.1 对应用的支持

从对应用的支持来讲，我门希望越靠上层次，越对应用友好。比如APP层，基本是完全为应用来设计的，很容易理解。DWS层的话，相对来讲就会有一点裂解成本，然后DWM和DWD层就更难理解了，因为它的维度可能会比较多，而且一个需求可能要多个表经过很复杂的计算才能完成。

### 5.2 能力范围

从能力范围来讲，我们希望80%需求有20%的表来支持。直接点讲，就是大部分（80%以上）的需求，都用DWS来支持就行，DWS支持不了的，就用DWM和DWD来支持，这些都支持不了的极少一部分数据需要从原始日志中捞取。结合第一点来讲的话就是：80%的需求，我们都希望以对应用很友好的方式来支持，而不是直接暴露给应用方原始日志。

### 5.3聚合程度

从数据聚合程度来jawing，我们希望，越上层数据的聚合程度越高。参考上面的例子，ODS和DWD的数据基本上都是原始日志的粒度，不做任何聚合操作，DWM做了轻度的聚合操作保留了通用的维度，DWS做了更高的聚合操作，可能只保留了一到两个能表征当前描述主题的维度。从这个角度来看，我们又可以理解为我们是按照数据的聚合程度来划分数据层次的。





## 六、参考

https://www.cnblogs.com/itboys/p/10592871.htmls