# ClickHouse向量引擎

## 一、前言

ClickHouse官网中，阐述了ClickHouse查询性能很强，之所以这么强，得益于他的数据库特性：

* 真正的列式数据库管理系统
* 数据压缩
* 数据的磁盘存储
* 多核心并行处理
* 多服务器分布式处理
* 支持SQL
* 向量引擎
* 实时的数据更新
* 适合在线查询
* 支持近似计算
* 自适应连接算法
* 支持数据复制和数据完整性
* 角色的访问控制



其他的东西或多或少可以理解，但是【向量引擎】是什么东西？





## 二、向量引擎介绍

> ClickHouse之所以会像闪电一样快，是多方面优化的结果，包括且不限于：高效且磁盘友好的列式存储，高效的数据压缩，精心设计的各类索引，并行分布式查询，运行时代码生成(Codegen)等。
> 另外，ClickHouse为了最大限度地压榨硬件—尤其是CPU的性能，实现了**向量化查询执行**（vectorized query execution）机制。
> 这个名词相对于上面的那些可能没那么平易近人，但它毫无疑问是CK相对于传统OLAP引擎的大杀器。鉴于现有资料中讲解CK向量化执行的内容很少，本文就来试图探究一下，先从基础知识SIMD说起。

### 2.1 SIMD

SIMD即"single instruction, multiple data"（单指令流多数据流），是Flynn分类法对计算机的四大分类之一。**它本质上是采用一个控制器来控制多个处理器，同时对一组数据中的每一条分别执行相同的操作，从而实现空间上的并行性的技术。**
可见，“单指令流”指的是同时只能执行一种操作，“多数据流”则指的是在一组同构的数据（通常称为vector，即向量）上进行操作，如下图所示，PU=processing unit。

![img](http://img.hurenjieee.com/uPic/webp.jpg)

SIMD在现代计算机的应用甚广泛，最典型的则是在GPU的像素处理流水线中。举个例子，如果要更改一整幅图像的亮度，只需要取出各像素的RGB值存入向量单元（向量单元很宽，可以存储多个像素的数据），再同时将它们做相同的加减操作即可，效率很高。



### 2.2 SSE指令集

SSE指令集是MMX的继任者，其第一版早在Pentium III时代就被引入了。随着新指令的扩充，又有了SSE2、SSE3、SSSE3、SSE4（包含4.1和4.2）等新版本。

ClickHouse提供的检查CPU是否支持SSE4.2的命令如下：

> grep -q sse4_2 /proc/cpuinfo && echo "SSE 4.2 supported" || echo "SSE 4.2 not supported"

SSE指令集以8个128位寄存器为基础，命名为XMM0~XMM7。在AMD64（即64位扩展）指令集中，又新增了XMM8~XMM15。一个XMM寄存器原本只能存储一种数据类型：

* 4个32位单精度浮点数

SSE2又扩展到能够存储以下类型：

- 2个64位双精度浮点数
- 2个64位/4个32位/8个16位整数
- 16个字节或字符

**可以理解为SSE 是一套专门为 SIMD（单指令多数据）架构设计的指令集。通过它，用户可以同时在多个数据片段上执行运算，实现数据并行（aka:矢量处理）。**



> ### 参考地址
>
> [漫谈SIMD、SSE指令集与ClickHouse向量化执行](https://www.jianshu.com/p/c36f4e142b8a)